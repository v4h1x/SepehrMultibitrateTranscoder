#!/bin/bash

cp /etc/system/masterHD /var/www/html/${NAME}/${NAME}.m3u8

VHX-NDI-ENCODER -v quiet -xerror -start_at_zero -copyts -copytb 1 -avioflags direct -fflags genpts+discardcorrupt+nobuffer+flush_packets -flush_packets 1 -allow_video_fields true -f libndi_newtek -i "$INPUT" -i /etc/system/logohd.png -filter_complex "zscale=w=1280:h=720,format=pix_fmts=yuv420p,fifo,hwupload_cuda=device=1,sharpen_npp[main];[1:v]hwupload_cuda=device=1[logo];[main][logo]overlay_cuda=x=1167:y=567,fifo,split=3[outv2][outp3][outp4];[outp3]scale_cuda=w=768:h=432,fifo[outv3];[outp4]scale_cuda=w=576:h=324,fifo[outv4]" -map [outv2] -map 0:a -map [outv3] -map 0:a -map [outv4] -map 0:a -c:v h264_nvenc -gpu 1 -preset:v p5 -rc 0 -qp 27 -g 125 -profile:v 2 -nonref_p 1 -bf:v 4 -b_ref_mode 2 -forced-idr 1 -strict_gop 1 -c:a libfdk_aac -b:a 96k -enc_time_base 0 -ignore_unknown -sn -dn -aspect 16:9 -avioflags direct -fflags flush_packets -f hls -var_stream_map "v:0,a:0,name:720p v:1,a:1,name:432p v:2,a:2,name:324p" -fflags flush_packets -flush_packets 1 -ignore_io_errors 1 -hls_flags "delete_segments+append_list+split_by_time+temp_file+round_durations" -hls_time 10 -hls_list_size 360 -hls_start_number_source datetime "/var/www/html/${NAME}/%v.m3u8"