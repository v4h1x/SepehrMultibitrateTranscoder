#!/bin/bash

INPUT=:1234 OUTPUT=228.12.12.27:2000 LOCALOUT=192.168.107.106 NAME=test GPU=0 PID=101

cp /etc/system/masterHD /var/www/html/${NAME}/${NAME}.m3u8

tsp -r --receive-timeout 30000000  -I ip --timestamp-priority kernel-tsp -l 192.168.132.106 ${INPUT} -P continuity -f -P craft --clear-discontinuity --clear-error -P fork "VHXTranscoder -v 32 -copyts -copytb 1 -avioflags direct -fflags genpts+discardcorrupt+nobuffer+flush_packets -flush_packets 1 -f mpegts -i - -map 0:v -map 0:a:0 -c copy -aspect 16:9 -avioflags direct -fflags flush_packets -flush_packets 1 -f mpegts -pcr_period 20 -pat_period 0.10 -sdt_period 0.25 -mpegts_service_type 25 -mpegts_copyts 1 -mpegts_pmt_start_pid 110 -mpegts_start_pid ${PID} -metadata service_provider="vahid.khamesi@outlook.com" -metadata service_name="$NAME" -metadata title="$NAME" -metadata publisher="VHX-ENCODER" -metadata:s:a:0 language=per -bsf:v h264_mp4toannexb -localaddr $LOCALOUT -buffer_size 1316 udp://${OUTPUT}?pkt_size=1316" | VHXTranscoder -threads 1 -abort_on empty_output -flush_packets 1 -v 32 -copyts -copytb 1 -hwaccel cuvid -hwaccel_device ${GPU} -c:v h264_cuvid -hwaccel_output_format nv12 -surfaces 20 -f mpegts -i - -i /etc/system/logohd.png -metadata title=${NAME} -metadata source=${INPUT} -filter_complex "[0:v]fifo,hwupload_cuda=device=${GPU},scale_cuda=format=yuv420p,sharpen_npp[main];[1:v]fifo,hwupload_cuda=device=${GPU}[logo];[main][logo]overlay_cuda=x=1167:y=567,split=3[outp2][outp3][outp4];[outp2]fifo[outv2];[outp3]scale_cuda=w=768:h=432,fifo[outv3];[outp4]scale_cuda=w=576:h=324,fifo[outv4]" -ac 2 -map [outv2] -map 0:a:0 -map [outv3] -map 0:a:0 -map [outv4] -map 0:a:0 -c:v h264_nvenc -gpu ${GPU} -preset:v 15 -rc 0 -qp 27 -g 125 -profile:v 2 -bf:v 4 -b_ref_mode 2 -b_adapt 0  -nonref_p 1 -strict_gop 1 -spatial-aq 1 -c:a libfdk_aac -b:a 96k -enc_time_base 0 -ignore_unknown -sn -dn -aspect 16:9 -avioflags direct -fflags flush_packets -f hls -var_stream_map 'v:0,a:0,name:720p v:1,a:1,name:432p v:2,a:2,name:324p' -ignore_io_errors 1 -hls_flags delete_segments+append_list+split_by_time+temp_file+round_durations+discont_start -hls_time 10 -hls_list_size 360 -hls_start_number_source datetime /var/www/html/${NAME}/%v.m3u8

