#!/bin/bash
video=$(echo $VIDEO | awk '{sub(/m|M/,"000000")}1'| awk '{sub(/k|K/,"000")}1' | awk '{sub(/ /,"")}1' | egrep -o "[0-9]{5,8}")
audio=$(echo $AUDIO | awk '{sub(/m|M/,"000000")}1'| awk '{sub(/k|K/,"000")}1' | awk '{sub(/ /,"")}1' | egrep -o "[0-9]{4,6}")
mux=$(echo $(((video+audio)*130/100 )))
VHX-NDI-ENCODER -v quiet -xerror -start_at_zero -copyts -copytb 1 -avioflags direct -fflags genpts+discardcorrupt+nobuffer+flush_packets -flush_packets 1 -allow_video_fields false -f libndi_newtek -i "$INPUT" -vf bwdif=0:0:0,zscale=w=1024:h=576,format=pix_fmts=yuv420p -map 0:v -map 0:a:0 -c:v h264_nvenc -gpu $GPU -b:v $video -maxrate $video -bf:v $BFRAME -b_ref_mode 2 -profile:v 2 -rc 2 -level 50 -coder cabac -preset:v 12 -cbr:v 1 -g $G -strict_gop 1 -rc-lookahead $G -no-scenecut 1 -c:a libfdk_aac -b:a $audio -aspect 16:9 -avioflags direct -fflags flush_packets -flush_packets 1 -f mpegts -muxrate $mux -pcr_period 20 -pat_period 0.10 -sdt_period 0.25 -mpegts_service_type 25 -mpegts_copyts 1 -mpegts_pmt_start_pid 110 -mpegts_start_pid $PID -metadata service_provider="eirib.ir" -metadata service_name="$NAME" -metadata title="$NAME" -metadata publisher="VHX-ENCODER" -metadata:s:a:0 language=per -bsf:v h264_mp4toannexb -localaddr $LOCAL -buffer_size 1316 udp://$OUTPUT?pkt_size=1316