#!/bin/bash
#for720p@25
find /var/www/html/${NAME} -name '*.ts' -mmin +61 -delete
find /var/www/html/${NAME} -name '*.tmp' -delete
cp /etc/system/masterHD /var/www/html/${NAME}/${NAME}.m3u8
VHXTranscoder -v quiet -abort_on empty_output -flush_packets 1 -fflags genpts+discardcorrupt+nobuffer+flush_packets -vsync passthrough -copyts -copytb 1 -i rtmp://${INPUT} -i /etc/system/logohd.png -filter_complex "[0:v]fifo,hwupload_cuda=device=${GPU},scale_cuda=format=yuv420p[main];[1:v]hwupload_cuda=device=${GPU}[logo];[main][logo]overlay_cuda=x=1167:y=567,fifo,split=3[outv2][outp3][outp4];[outp3]scale_cuda=w=768:h=432,fifo[outv3];[outp4]scale_cuda=w=576:h=324,fifo[outv4]" -map [outv2] -map 0:a -map [outv3] -map 0:a -map [outv4] -map 0:a -c:v h264_nvenc -gpu 1 -preset:v p4 -rc 0 -qp 27 -g 125 -profile:v 2 -bf:v 4 -b_ref_mode 2 -forced-idr 1 -strict_gop 1 -c:a copy -enc_time_base 0 -ignore_unknown -sn -dn -aspect 16:9 -avioflags direct -fflags flush_packets -f hls -var_stream_map "v:0,a:0,name:720p v:1,a:1,name:432p v:2,a:2,name:324p" -fflags flush_packets -flush_packets 1 -ignore_io_errors 1 -hls_flags delete_segments+append_list+split_by_time+temp_file+round_durations -hls_time 10 -hls_list_size 360 -hls_start_number_source datetime /var/www/html/${NAME}/%v.m3u8
